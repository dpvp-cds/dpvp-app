<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle de Reporte - DPvP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #F8F7F2; color: #6B6661; }
        h1, h2, h3, h4 { font-family: 'Playfair Display', serif; color: #070404; }
        .card { background-color: white; border-radius: 16px; padding: 2rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .demographic-item { border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; margin-bottom: 0.5rem; }
        .demographic-item:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <header class="bg-[#F8F7F2] py-4 px-8 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <a href="index.html"><img src="logoprincipal.png" alt="Logo Caminos del Ser" class="h-12 w-auto"></a>
            <a href="portal.html" class="text-sm font-semibold text-[#6B6661] hover:underline">&larr; Volver al Portal</a>
        </div>
    </header>
    <main id="mainContent" class="container mx-auto px-6 py-12 hidden">
        <section id="vistaPrivada" class="max-w-5xl mx-auto">
             <h2 class="text-3xl md:text-4xl font-bold text-center mb-8">Resultados del Diagnóstico</h2>
             <div id="datosDemograficos" class="card mb-8"></div>
             <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div class="lg:col-span-3 card">
                    <h3 class="text-2xl font-bold mb-4 text-center">Rueda de Proyecto de Vida en Pareja</h3>
                    <canvas id="graficaResultados"></canvas>
                </div>
                <div class="lg:col-span-2 card">
                    <h3 class="text-2xl font-bold mb-4 text-center">Puntuaciones por Ámbito</h3>
                    <table class="w-full">
                        <thead class="border-b-2 border-gray-200">
                            <tr>
                                <th class="py-2 text-left font-semibold">Ámbito</th>
                                <th class="py-2 text-right font-semibold">Puntaje (/10)</th>
                            </tr>
                        </thead>
                        <tbody id="tablaResultados"></tbody>
                    </table>
                </div>
                <div class="lg:col-span-5 card mt-4">
                    <h3 class="text-2xl font-bold mb-4">Interpretación Preliminar</h3>
                    <div id="interpretacionResultados"></div>
                </div>
                <div id="respuestasDetalladas" class="lg:col-span-5 card mt-4"></div>
             </div>
        </section>
    </main>
    <div id="loading" class="text-center py-20">Cargando reporte...</div>
    <script>
        if (sessionStorage.getItem('terapeutaAuth') !== 'true') {
            window.location.href = 'terapeuta-login.html';
        }

        const ambitosTextos = {
            "Ámbito Económico": ["1. ¿Ambos participan en la construcción del presupuesto familiar?", "2. ¿Ambos miembros aportan económicamente?", "3. ¿Ambos consideran que tienen un buen acuerdo en lo económico?", "4. ¿Ambos son sinceros con su pareja en el tema económico?"],
            "Ámbito Emocional": ["5. ¿Ambos consideran que hay adecuada comunicación en la pareja?", "6. ¿Ambos se respetan totalmente, sin presencia de algún tipo de maltrato? (físico, verbal, etc.)", "7. ¿Ambos sienten aún amor por su pareja?", "8. ¿Ambos están de acuerdo en todos los temas sexuales en la pareja?"],
            "Ámbito Salud": ["9. ¿Ambos están sanos, sin ninguna enfermedad/discapacidad grave o importante?", "10. ¿Ambos tienen cobertura de salud?", "11. ¿Ambos atienden con celeridad cuando se presenta algún tema de salud?", "12. ¿Ambos apoyan cualquier situación de salud que se presente en la familia?"],
            "Ámbito Laboral": ["13. ¿Ambos miembros se sienten realizados profesional/laboralmente?", "14. ¿Ambos miembros tienen algún tipo de trabajo remunerado?", "15. ¿Ambos han propuesto un plan de vida para la vejez?", "16. ¿Ambos se sienten apoyados laboralmente por su pareja?"],
            "Ámbito Ocio": ["17. ¿Ambos reconocen gustos y hobbies en común?", "18. ¿Ambos han creado/propuesto algún espacio exclusivo para compartir como pareja?", "19. ¿Ambos miembros tienen espacios individuales para sí mismos?", "20. ¿Ambos celebran y recuerdan fechas especiales como cumpleaños y aniversarios?"],
            "Ámbito Hijos": ["21. ¿Ambos hablaron con claridad el tema de los hijos antes de vivir en pareja?", "22. ¿Ambos estuvieron o están de acuerdo en el número de hijos a tener?", "23. ¿Ambos se sienten libres de presión por el tema de los hijos?", "24. ¿Ambos están de acuerdo en el tema de mascotas en el hogar?"],
            "Ámbito Hogar": ["25. ¿Ambos participaron en la escogencia del lugar donde viven?", "26. ¿Ambos se sienten a gusto y felices en el lugar donde viven?", "27. ¿Ambos permitirían convivir con otras personas diferentes a la pareja e hijos?", "28. ¿Ambos realizan por igual o bajo un acuerdo las tareas del hogar?"],
            "Ámbito Espiritual": ["29. ¿Ambos miembros comparten la misma creencia religiosa/espiritual?", "30. ¿Ambos aceptan las creencias personales de la pareja?", "31. ¿Ambos miembros de la pareja son felices?", "32. ¿Ambos miembros desean continuar en su relación de pareja actual?"]
        };

        function mostrarReporte(datosCompletos) {
            const { resultados, detalles, demograficos } = datosCompletos;
            
            const demoContainer = document.getElementById('datosDemograficos');
            const unionMap = { solo_novios: 'Solo novios (sin convivir)', union_libre: 'Unión Libre', religion: 'Casados por religión', civil: 'Casados por lo civil' };
            demoContainer.innerHTML = `<h3 class="text-2xl font-bold mb-4 text-center">Datos de la Pareja</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2">
                    <div><p class="demographic-item"><strong>Miembro 1:</strong> ${demograficos.m1_nombre} (${demograficos.m1_edad} años)</p><p class="demographic-item"><strong>Ocupación:</strong> ${demograficos.m1_ocupacion}</p></div>
                    <div><p class="demographic-item"><strong>Miembro 2:</strong> ${demograficos.m2_nombre} (${demograficos.m2_edad} años)</p><p class="demographic-item"><strong>Ocupación:</strong> ${demograficos.m2_ocupacion}</p></div>
                    <div class="md:col-span-2 border-t mt-4 pt-4"><p class="demographic-item"><strong>Tiempo total de relación:</strong> ${demograficos.tiempo_relacion} años</p>${demograficos.tipo_union !== 'solo_novios' ? `<p class="demographic-item"><strong>Tiempo de convivencia:</strong> ${demograficos.tiempo_convivencia} años</p>` : ''}<p class="demographic-item"><strong>Tipo de Unión:</strong> ${unionMap[demograficos.tipo_union] || 'No especificado'}</p>${(demograficos.tipo_union === 'religion' || demograficos.tipo_union === 'civil') ? `<p class="demographic-item"><strong>Años de casados:</strong> ${demograficos.anos_casados} años</p>` : ''}<p class="demographic-item"><strong>Hijos:</strong> ${demograficos.num_hijos} | <strong>Mascotas:</strong> ${demograficos.num_mascotas}</p></div>
                </div>`;

            const tablaBody = document.getElementById('tablaResultados');
            tablaBody.innerHTML = Object.keys(resultados).sort((a, b) => resultados[b] - resultados[a]).map(ambito => {
                const puntaje = resultados[ambito];
                return `<tr class="border-t border-gray-100"><td class="py-3">${ambito}</td><td class="py-3 text-right font-bold ${puntaje < 5 ? 'text-red-600' : puntaje >= 8 ? 'text-green-600' : 'text-yellow-600'}">${puntaje.toFixed(2)}</td></tr>`;
            }).join('');

            const respuestasContainer = document.getElementById('respuestasDetalladas');
            respuestasContainer.innerHTML = `<h3 class="text-2xl font-bold mb-4 text-center">Respuestas Detalladas</h3>` + Object.keys(ambitosTextos).map(ambito => {
                let html = `<div class="mb-4"><h4 class="text-xl font-semibold mb-2">${ambito}</h4><ul class="list-disc list-inside space-y-1">`;
                ambitosTextos[ambito].forEach((pregunta, index) => {
                    const respuesta = detalles[ambito][index];
                    let respuestaTexto = (typeof respuesta === 'object' && respuesta !== null) ? `<strong>${respuesta.respuesta}</strong> (Seleccionado: ${respuesta.quien === 'Miembro 1' ? demograficos.m1_nombre : demograficos.m2_nombre})` : `<strong>${respuesta}</strong>`;
                    html += `<li>${pregunta}: ${respuestaTexto}</li>`;
                });
                return html + `</ul></div>`;
            }).join('');

            const criticos = Object.entries(resultados).filter(([, p]) => p < 5).sort((a, b) => a[1] - b[1]);
            const fuertes = Object.entries(resultados).filter(([, p]) => p >= 8).sort((a, b) => b[1] - a[1]);
            let interpretacionHtml = `<p class="mb-4">Análisis preliminar para guiar la entrevista clínica.</p>`;
            if (criticos.length > 0) {
                interpretacionHtml += `<h4 class="text-xl font-bold text-red-700 mt-6 mb-2">Áreas Prioritarias (< 5.0)</h4><ul class="list-disc list-inside space-y-2">`;
                criticos.forEach(([ambito, puntaje]) => { interpretacionHtml += `<li><strong>${ambito}:</strong> <span class="font-bold text-red-600">${puntaje.toFixed(2)}</span> - Indica desconexión significativa.</li>`; });
                interpretacionHtml += `</ul>`;
            }
            if (fuertes.length > 0) {
                interpretacionHtml += `<h4 class="text-xl font-bold text-green-700 mt-6 mb-2">Fortalezas (≥ 8.0)</h4><ul class="list-disc list-inside space-y-2">`;
                fuertes.forEach(([ambito, puntaje]) => { interpretacionHtml += `<li><strong>${ambito}:</strong> <span class="font-bold text-green-600">${puntaje.toFixed(2)}</span> - Representa una base sólida de consenso.</li>`; });
                interpretacionHtml += `</ul>`;
            }
            document.getElementById('interpretacionResultados').innerHTML = interpretacionHtml;

            const ctx = document.getElementById('graficaResultados').getContext('2d');
            new Chart(ctx, {
                type: 'polarArea',
                data: {
                    labels: Object.keys(resultados),
                    datasets: [{
                        label: 'Puntuación por Ámbito',
                        data: Object.values(resultados),
                        backgroundColor: ['rgba(232, 166, 19, 0.7)', 'rgba(7, 4, 4, 0.7)', 'rgba(0, 180, 216, 0.7)', 'rgba(0, 119, 182, 0.7)', 'rgba(244, 143, 177, 0.7)', 'rgba(100, 181, 246, 0.7)', 'rgba(129, 199, 132, 0.7)', 'rgba(186, 104, 200, 0.7)'],
                    }]
                },
                options: { scales: { r: { max: 10, min: 0, ticks: { stepSize: 2 } } } }
            });

            document.getElementById('loading').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
        }

        async function fetchReporteIndividual() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            if (!id) {
                document.getElementById('loading').textContent = 'ID de reporte no encontrado.';
                return;
            }

            try {
                const response = await fetch(`/api/get-reporte?id=${id}`);
                if (!response.ok) throw new Error('Error al obtener el reporte');
                const reporte = await response.json();
                mostrarReporte(reporte);
            } catch (error) {
                console.error(error);
                document.getElementById('loading').textContent = 'Error al cargar el reporte.';
            }
        }

        fetchReporteIndividual();
    </script>
</body>
</html>
