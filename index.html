<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Escala DPvP - Diagnóstico en Proyecto de Vida en Pareja</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&display=swap"
    rel="stylesheet"
  />
  <style>
    body { font-family: 'Poppins', sans-serif; background:#f8f7f2; color:#6b6661; }
    h1,h2,h3 { font-family: 'Playfair Display', serif; color:#070404; }
    .btn-brand {
      background-color:#e6a613;color:#fff;padding:12px 30px;border-radius:9999px;font-weight:600;transition:background-color 0.3s ease; cursor:pointer;
    }
    .btn-brand:hover:not(:disabled) { background-color:#d4940f; }
    .btn-brand:disabled { background-color:#f3d68b; cursor:not-allowed; }
    .input-styled {
      border:1px solid #d1d5db;border-radius:8px;padding:10px 15px;width:100%;
    }
    .card {
      background:#fff;border-radius:16px;padding:2rem;
      box-shadow:0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -2px rgba(0,0,0,0.05);
      margin-bottom:2rem;
    }
    .radio-option { display:inline-block;margin-right:1rem; }
    .radio-option input[type="radio"] { display:none; }
    .radio-option label {
      display:inline-block;padding:0.5rem 1.25rem;border:2px solid #e5e7eb;border-radius:9999px;cursor:pointer;
      transition:all 0.2s ease-in-out;
    }
    .radio-option input[type="radio"]:checked + label {
      background:#e6a613;color:#fff;border-color:#e6a613;
    }
    .checkbox-label { cursor:pointer; }
    .sub-question {
      transition:all 0.3s ease;
      max-height:0;overflow:hidden;
    }
    .sub-question.visible {
      max-height:100px;margin-top:0.75rem;
    }
  </style>
</head>
<body>

<header class="bg-[#f8f7f2] py-4 px-8 shadow-md sticky top-0 z-50">
  <div class="container mx-auto flex justify-between items-center">
    <a href="index.html"><img src="logoprincipal.png" alt="Logo Caminos del Ser" class="h-12 w-auto" /></a>
    <nav class="hidden md:flex space-x-8">
      <a href="https://www.caminosdelser.co/#about" class="text-[#6b6661] hover:text-[#e6a613]">Sobre Mí</a>
      <a href="https://www.caminosdelser.co/#services" class="text-[#6b6661] hover:text-[#e6a613]">Servicios</a>
      <a href="index.html" class="text-[#e6a613] font-semibold">Escala DPvP</a>
      <a href="https://www.caminosdelser.co/#contact" class="text-[#6b6661] hover:text-[#e6a613]">Contacto</a>
    </nav>
    <button class="md:hidden text-3xl text-[#070404]">☰</button>
  </div>
</header>

<main class="container mx-auto px-6 py-12">

  <!-- Formulario datos iniciales -->
  <section id="datosIniciales" class="card max-w-4xl mx-auto">
    <form id="formularioDatos" novalidate>
      <h1 class="text-4xl font-bold mb-6 text-center">Antecedentes de la pareja</h1>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
        <div>
          <label for="m1_nombre" class="block font-semibold mb-1">Nombre completo Miembro 1</label>
          <input id="m1_nombre" type="text" class="input-styled" required />
        </div>
        <div>
          <label for="m2_nombre" class="block font-semibold mb-1">Nombre completo Miembro 2</label>
          <input id="m2_nombre" type="text" class="input-styled" required />
        </div>
        <div>
          <label for="m1_edad" class="block font-semibold mb-1">Edad Miembro 1</label>
          <input id="m1_edad" type="number" min="0" class="input-styled" required />
        </div>
        <div>
          <label for="m2_edad" class="block font-semibold mb-1">Edad Miembro 2</label>
          <input id="m2_edad" type="number" min="0" class="input-styled" required />
        </div>
        <div>
          <label for="m1_ocupacion" class="block font-semibold mb-1">Profesión/Ocupación Miembro 1</label>
          <input id="m1_ocupacion" type="text" class="input-styled" required />
        </div>
        <div>
          <label for="m2_ocupacion" class="block font-semibold mb-1">Profesión/Ocupación Miembro 2</label>
          <input id="m2_ocupacion" type="text" class="input-styled" required />
        </div>

        <div>
          <label for="tiempo_relacion" class="block font-semibold mb-1">Tiempo total relación (años)</label>
          <input id="tiempo_relacion" type="number" min="0" class="input-styled" required />
        </div>
        <div>
          <label for="tipo_union" class="block font-semibold mb-1">Tipo de unión</label>
          <select id="tipo_union" class="input-styled" required>
            <option value="">Seleccione una opción</option>
            <option value="solo_novios">Solo novios (sin convivir)</option>
            <option value="union_libre">Unión libre</option>
            <option value="religion">Casados por religión</option>
            <option value="civil">Casados civilmente</option>
          </select>
        </div>
        <div id="tiempo_convivencia_wrapper">
          <label for="tiempo_convivencia" class="block font-semibold mb-1">Años de convivencia</label>
          <input id="tiempo_convivencia" type="number" min="0" class="input-styled" />
        </div>
        <div id="anos_casados_wrapper" style="display:none;">
          <label for="anos_casados" class="block font-semibold mb-1">Años casados</label>
          <input id="anos_casados" type="number" min="0" class="input-styled" />
        </div>
        <div>
          <label for="num_hijos" class="block font-semibold mb-1">Número de hijos</label>
          <input id="num_hijos" type="number" min="0" class="input-styled" required />
        </div>
        <div>
          <label for="num_mascotas" class="block font-semibold mb-1">Número de mascotas</label>
          <input id="num_mascotas" type="number" min="0" class="input-styled" required />
        </div>
      </div>

      <div class="text-center">
        <button type="submit" class="btn-brand">Comenzar cuestionario</button>
      </div>
    </form>
  </section>

  <!-- Cuestionario (oculto inicialmente) -->
  <section id="cuestionario" class="card max-w-4xl mx-auto" style="display:none;">
    <form id="formularioCuestionario">
      <h1 class="text-3xl font-bold mb-6 text-center">Cuestionario DPvP</h1>
      <div id="preguntas"></div>
      <div class="mb-6">
        <label>
          <input type="checkbox" id="confirmacion" required />
          Certificamos que respondimos con total sinceridad.
        </label>
      </div>
      <div class="text-center">
        <button type="submit" class="btn-brand" id="btnEnviarCuestionario">Finalizar y enviar</button>
      </div>
    </form>
  </section>

</main>

<footer class="bg-[#070404] text-white py-6 mt-20 text-center">
  <p>© 2025 Jorge Arango Castaño - Caminos del Ser. Todos los derechos reservados.</p>
  <a href="terapeuta-login.html" class="underline text-gray-400">Acceso terapeuta</a>
</footer>

<script>
  const tipoUnion = document.getElementById('tipo_union');
  const tiempoConvivenciaWrapper = document.getElementById('tiempo_convivencia_wrapper');
  const anosCasadosWrapper = document.getElementById('anos_casados_wrapper');
  const tiempoConvivenciaInput = document.getElementById('tiempo_convivencia');
  const anosCasadosInput = document.getElementById('anos_casados');

  tipoUnion.addEventListener('change', () => {
    if (tipoUnion.value === 'solo_novios') {
      tiempoConvivenciaWrapper.style.display = 'none';
      anosCasadosWrapper.style.display = 'none';
      tiempoConvivenciaInput.required = false;
      anosCasadosInput.required = false;
    } else if (tipoUnion.value === 'religion' || tipoUnion.value === 'civil') {
      tiempoConvivenciaWrapper.style.display = 'none';
      anosCasadosWrapper.style.display = 'block';
      tiempoConvivenciaInput.required = false;
      anosCasadosInput.required = true;
    } else {
      tiempoConvivenciaWrapper.style.display = 'block';
      anosCasadosWrapper.style.display = 'none';
      tiempoConvivenciaInput.required = true;
      anosCasadosInput.required = false;
    }
  });

  // Ámbitos y preguntas
  const ambitos = {
    "Ámbito Económico": [
      "¿Participan ambos en presupuesto familiar?",
      "¿Aportan ambos económicamente?",
      "¿Acuerdo en economía?",
      "¿Sinceridad en tema económico?"
    ],
    "Ámbito Emocional": [
      "¿Buena comunicación?",
      "¿Ausencia de maltrato?",
      "¿Todavía hay amor?",
      "¿Acuerdo en temas sexuales?"
    ],
    "Ámbito Salud": [
      "¿Están ambos sanos?",
      "¿Cobertura médica?",
      "¿Atención oportuna en salud?",
      "¿Apoyo en situaciones de salud?"
    ],
    "Ámbito Laboral": [
      "¿Realización profesional?",
      "¿Trabajo remunerado?",
      "¿Plan para vejez?",
      "¿Apoyo laboral mutuo?"
    ],
    "Ámbito Ocio": [
      "¿Gustos o hobbies comunes?",
      "¿Espacios exclusivos para pareja?",
      "¿Espacios personales?",
      "¿Celebraciones y fechas importantes?"
    ],
    "Ámbito Hijos": [
      "¿Acuerdan sobre hijos?",
      "¿Número de hijos decidido?",
      "¿Libertad respecto a hijos?",
      "¿Acuerdo sobre mascotas?"
    ],
    "Ámbito Hogar": [
      "¿Decisiones sobre lugar de vivienda?",
      "¿Satisfacción con el lugar?",
      "¿Aceptan convivir con otros?",
      "¿Participan tareas hogareñas?"
    ],
    "Ámbito Espiritual": [
      "¿Coinciden en creencias?",
      "¿Aceptan diferencia en creencias?",
      "¿Son felices en pareja?",
      "¿Quieren continuar la relación?"
    ]
  };

  // Referencias DOM
  const formularioDatos = document.getElementById('formularioDatos');
  const formularioCuestionario = document.getElementById('formularioCuestionario');
  const seccionDatos = document.getElementById('datosIniciales');
  const seccionCuestionario = document.getElementById('cuestionario');
  const preguntasDiv = document.getElementById('preguntas');

  // Envío datos iniciales
  formularioDatos.addEventListener('submit', e => {
    e.preventDefault();

    const datosPareja = {
      m1_nombre: document.getElementById('m1_nombre').value,
      m1_edad: parseInt(document.getElementById('m1_edad').value, 10),
      m1_ocupacion: document.getElementById('m1_ocupacion').value,
      m2_nombre: document.getElementById('m2_nombre').value,
      m2_edad: parseInt(document.getElementById('m2_edad').value, 10),
      m2_ocupacion: document.getElementById('m2_ocupacion').value,
      tiempo_relacion: parseInt(document.getElementById('tiempo_relacion').value, 10),
      tipo_union: document.getElementById('tipo_union').value,
      tiempo_convivencia: parseInt(document.getElementById('tiempo_convivencia').value || 0, 10),
      anos_casados: parseInt(document.getElementById('anos_casados').value || 0, 10),
      num_hijos: parseInt(document.getElementById('num_hijos').value, 10),
      num_mascotas: parseInt(document.getElementById('num_mascotas').value, 10)
    };

    sessionStorage.setItem('datosPareja', JSON.stringify(datosPareja));

    seccionDatos.style.display = 'none';
    seccionCuestionario.style.display = 'block';
    cargarPreguntas();
    window.scrollTo({top: 0, behavior: 'smooth'});
  });

  function cargarPreguntas() {
    preguntasDiv.innerHTML = '';
    let i = 1;
    for (const ambito in ambitos) {
      const divAmbito = document.createElement('div');
      divAmbito.className = 'mb-8';

      const titulo = document.createElement('h3');
      titulo.textContent = ambito;
      titulo.className = 'text-xl font-semibold mb-3';
      divAmbito.appendChild(titulo);

      ambitos[ambito].forEach(pregunta => {
        const divPregunta = document.createElement('div');
        divPregunta.className = 'mb-3';

        const label = document.createElement('label');
        label.textContent = `${i}. ${pregunta}`;
        label.className = 'block font-semibold mb-1';
        divPregunta.appendChild(label);

        ['Ambos', 'Solo Uno', 'Ninguno'].forEach(valor => {
          const divOpcion = document.createElement('div');
          divOpcion.className = 'inline-block mr-4';

          const input = document.createElement('input');
          input.type = 'radio';
          input.name = `pregunta_${i}`;
          input.id = `pregunta_${i}_${valor}`;
          input.value = valor;
          input.required = true;

          const labelOpcion = document.createElement('label');
          labelOpcion.htmlFor = input.id;
          labelOpcion.textContent = valor;
          labelOpcion.className = 'ml-1 cursor-pointer';

          divOpcion.appendChild(input);
          divOpcion.appendChild(labelOpcion);
          divPregunta.appendChild(divOpcion);
        });

        divAmbito.appendChild(divPregunta);
        i++;
      });

      preguntasDiv.appendChild(divAmbito);
    }
  }

  formularioCuestionario.addEventListener('submit', async e => {
    e.preventDefault();

    const boton = document.getElementById('btnEnviarCuestionario');
    boton.disabled = true;
    boton.textContent = 'Enviando...';

    const formData = new FormData(formularioCuestionario);
    const respuestas = {};
    let contador = 1;

    for (const ambito in ambitos) {
      respuestas[ambito] = [];
      ambitos[ambito].forEach(() => {
        respuestas[ambito].push(formData.get(`pregunta_${contador}`));
        contador++;
      });
    }

    const puntos = { 'Ambos': 2.5, 'Solo Uno': 1.25, 'Ninguno': 0.25 };
    const resultados = {};
    for (const ambito in respuestas) {
      resultados[ambito] = respuestas[ambito].reduce((acum, val) => acum + (puntos[val] || 0), 0);
    }

    const datosPareja = JSON.parse(sessionStorage.getItem('datosPareja')) || {};

    const datosCompletos = {
      demograficos: datosPareja,
      resultados,
      detalles: respuestas
    };

    sessionStorage.setItem('dpvpResultados', JSON.stringify(datosCompletos));

    try {
      const res = await fetch('/api/enviar-reporte', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(datosCompletos)
      });

      if (!res.ok) {
        alert('Error al enviar datos al servidor.');
        boton.disabled = false;
        boton.textContent = 'Finalizar y enviar';
        return;
      }

      window.location.href = 'rdpv.html';
    } catch (error) {
      alert('Error en conexión. Intente nuevamente.');
      boton.disabled = false;
      boton.textContent = 'Finalizar y enviar';
    }
  });
</script>

</body>
</html>
